import{_ as F,c as N,o as h,w as i,a as s,b as o,Q as b,e as x,f as p,aq as g,a5 as _,a6 as y,a7 as w,t as c,a1 as Q,d as I,Z as f,aB as v,a8 as E,h as D,aD as S}from"./index-CDMh4ULy.js";import{Q as B}from"./QPagination-B_HW17Zc.js";import{Q as C}from"./QImg-CyTZYFC4.js";import{Q as k}from"./QMarkupTable-sa2P-3Yl.js";import{Q as V}from"./QForm-TCfybJYC.js";import{Q as P}from"./QSpace-BYXQnY-Y.js";import{Q as q}from"./QSelect-D5K4Nbzj.js";import{Q as T}from"./QPage-B6Uc9IDp.js";import{I as R}from"./Imprimir-D1uOxir8.js";import{h as U}from"./moment-C5S46NFB.js";import"./format-CJebrXOQ.js";import"./QMenu-BiOLrQ69.js";import"./_commonjsHelpers-Bx2EM-6T.js";const G={name:"ComprasCreate",data(){return{proveedorDialog:!1,formProveedorRef:null,proveedorForm:{nombre:"",ci:"",telefono:"",email:"",direccion:""},loading:!1,compraDialog:!1,productos:[],productosSearch:"",productosCompras:[],proveedores:[],proveedor:null,compra:{nit:"",nombre:"",tipo_pago:"Efectivo"},pagination:{page:1,rowsPerPage:24,rowsNumber:0}}},computed:{totalCompra(){let r=0;return this.productosCompras.forEach(e=>{r+=e.cantidad*e.precio}),parseFloat(r).toFixed(2)}},methods:{tiempoRestante(r){if(!r)return"";const e=U(),m=U(r).diff(e);if(m<0)return"Vencido";const l=U.duration(m),n=l.years(),t=l.months(),u=l.days();let a="";return n>0&&(a+=`${n} a `),t>0&&(a+=`${t} m `),u>0&&(a+=`${u} d`),a.trim()},getImagenUrl(r){return`${this.$url}../images/${r}`},formatPrice(r){const e=Number(r)||0;return parseFloat(e.toFixed(1))},round2(r){return Math.round((Number(r)||0)*100)/100},round3(r){return Math.round((Number(r)||0)*1e3)/1e3},roundTo(r){const e=Number(r)||0;return Math.ceil(e/.5)*.5},openProveedorDialog(){this.resetProveedorForm(),this.proveedorDialog=!0},closeProveedorDialog(){this.proveedorDialog=!1},resetProveedorForm(){this.proveedorForm={nombre:"",ci:"",telefono:"",email:"",direccion:""}},async saveProveedor(){await this.$refs.formProveedorRef.validate()&&(this.loading=!0,this.$axios.post("proveedores",this.proveedorForm).then(e=>{const d=e.data;this.proveedores.unshift(d),this.proveedor=d,this.compra.nombre=d.nombre||"",this.compra.ci=d.ci||"",this.$alert?.success?.("Proveedor creado correctamente")||this.$q.notify({type:"positive",message:"Proveedor creado correctamente"}),this.proveedorDialog=!1,this.resetProveedorForm()}).catch(e=>{console.error("Error creando proveedor:",e),this.$alert?.error?.("No se pudo crear el proveedor")||this.$q.notify({type:"negative",message:"No se pudo crear el proveedor"})}).finally(()=>{this.loading=!1}))},onCantidadChange(r){const e=Number(r.cantidad)||0,d=Number(r.precio)||0;r.total=this.round2(e*d),this.updatePrecioVenta(r)},onPrecioChange(r){const e=Number(r.cantidad)||0,d=Number(r.precio)||0;r.total=this.round2(e*d),this.updatePrecioVenta(r)},onTotalChange(r){const e=Number(r.cantidad)||0,d=Number(r.total)||0;r.precio=e>0?this.round3(d/e):0,this.updatePrecioVenta(r)},onFactorChange(r){this.updatePrecioVenta(r)},updatePrecioVenta(r){const e=Number(r.precio)||0,d=Number(r.factor)||1,m=e*d;r.precio_venta=this.roundTo(m,1)},recuperarPedido(){this.$q.dialog({title:"Recuperar pedido",message:"Ingrese el ID del pedido",prompt:{model:"",type:"text",isValid:r=>!!r||"Campo requerido"},persistent:!0,cancel:!0,ok:{label:"Recuperar",color:"primary"}}).onOk(r=>{this.loading=!0,this.$axios.get("recuperarPedido",{params:{id:r}}).then(e=>{if(!e.data.detalles||e.data.detalles.length===0){this.$alert.error("No se encontraron productos en el pedido");return}e.data.detalles.forEach(d=>{const m=d.producto,l=this.productosCompras.find(n=>n.producto_id===m.id);l?l.cantidad+=1:this.productosCompras.push({producto_id:m.id,cantidad:parseInt(d.cantidad),precio:"",lote:"",fecha_vencimiento:"",producto:m,factor:1.3,precio_venta:""})})}).catch(e=>{console.error("Error recuperando pedido:",e)}).finally(()=>{this.loading=!1})})},productosGet(){this.loading=!0,this.$axios.get("productos",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(r=>{this.productos=r.data.data,this.pagination.rowsNumber=r.data.total}).catch(r=>{console.error("Error cargando productos:",r)}).finally(()=>{this.loading=!1})},addProducto(r){this.productosCompras.push({producto_id:r.id,cantidad:1,precio:"",total:"",lote:"",fecha_vencimiento:"",producto:r,factor:1.3,precio_venta:""})},clickDialogCompra(){if(this.productosCompras.length===0){this.$alert.error("Debe agregar al menos un producto");return}if(this.productosCompras.filter(e=>!e.precio||e.precio<=0).length>0){this.$alert.error("Todos los productos deben tener precio unitario");return}this.compraDialog=!0},submitCompra(){this.loading=!0;const r={tipo_pago:this.compra.tipo_pago,proveedor_id:this.proveedor.id,nro_factura:this.compra.nro_factura,productos:this.productosCompras,agencia:this.compra.agencia};this.$axios.post("compras",r).then(e=>{this.$alert.success("Compra registrada correctamente"),this.compraDialog=!1,this.productosCompras=[],R.reciboCompra(e.data),this.productosGet(),this.compra={nit:"",nombre:"",tipo_pago:"Efectivo"},this.proveedor=null}).catch(e=>{console.error("Error registrando compra:",e),this.$alert.error("Error al registrar la compra")}).finally(()=>{this.loading=!1})},proveedoresGet(){this.$axios.get("proveedores").then(r=>{this.proveedores=r.data}).catch(r=>{console.error("Error cargando proveedores:",r)})}},mounted(){this.productosGet(),this.proveedoresGet()}},M={class:"row"},z={class:"col-12 col-md-5 q-pa-xs"},L={class:"flex flex-center"},j={class:"row"},O={class:"col-6 col-md-2"},Z={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},A={style:{"max-width":"190px","line-height":"0.9"}},H={style:{display:"flex","justify-content":"space-between"}},J={class:"text-bold bg-orange text-black border"},K={class:"col-12 col-md-7 q-pa-xs"},W={style:{display:"flex","align-items":"center","justify-content":"space-between"}},X={class:"pm-none",style:{display:"flex","align-items":"center"}},Y={style:{"max-width":"120px","wrap-option":"warp","line-height":"0.9"}},$={class:"pm-none"},ee=["onUpdate:modelValue","onInput"],oe={class:"pm-none"},te=["onUpdate:modelValue","onInput"],re={class:"text-right pm-none"},se=["onUpdate:modelValue","onInput"],le={class:"pm-none"},ne=["onUpdate:modelValue","onInput"],ae={class:"text-right pm-none text-bold"},ie={class:"text-right pm-none"},de={class:"pm-none"},ce=["onUpdate:modelValue"],pe={class:"pm-none"},me=["onUpdate:modelValue"],ue={class:"pm-none"},he=["onUpdate:modelValue"],ge={class:"pm-none text-right"},fe={class:"text-right"},ve={class:"row"},xe={class:"col-12 col-md-6 q-pa-xs"},_e={class:"col-12 col-md-6 q-pa-xs"},be={class:"col-12 col-md-6 q-pa-xs"},ye={class:"col-12"},we={class:"pm-none",style:{display:"flex","align-items":"center"}},Ce={style:{"max-width":"120px","wrap-option":"warp","line-height":"0.9"}},Ve={class:"pm-none"},Pe={class:"pm-none text-red text-bold text-right"},Ue={class:"pm-none"},De={class:"pm-none"},ke={class:"row q-col-gutter-sm"},qe={class:"col-12"},Fe={class:"col-12 col-md-6"},Ne={class:"col-12 col-md-6"},Qe={class:"col-12"},Ie={class:"col-12"},Ee={class:"row q-gutter-sm q-mt-md"};function Se(r,e,d,m,l,n){return h(),N(T,{class:"q-pa-xs"},{default:i(()=>[s(b,{flat:"",bordered:""},{default:i(()=>[s(x,{class:"row items-center q-pb-none"},{default:i(()=>[e[16]||(e[16]=o("div",{class:"text-h6"},"Compras",-1)),s(p,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:e[0]||(e[0]=t=>r.$router.back()),class:"q-mr-sm"})]),_:1}),s(x,{class:"q-pa-none"},{default:i(()=>[s(V,{onSubmit:n.clickDialogCompra},{default:i(()=>[o("div",M,[o("div",z,[s(g,{modelValue:l.productosSearch,"onUpdate:modelValue":[e[1]||(e[1]=t=>l.productosSearch=t),n.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:i(()=>[s(p,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),o("div",L,[s(B,{modelValue:l.pagination.page,"onUpdate:modelValue":[e[2]||(e[2]=t=>l.pagination.page=t),n.productosGet],max:Math.ceil(l.pagination.rowsNumber/l.pagination.rowsPerPage),"max-pages":"5",size:"xs","boundary-numbers":"",class:"q-mt-sm"},null,8,["modelValue","max","onUpdate:modelValue"])]),o("div",j,[(h(!0),_(y,null,w(l.productos,t=>(h(),_("div",O,[s(b,{flat:"",bordered:"",class:"cursor-pointer",onClick:u=>n.addProducto(t)},{default:i(()=>[s(C,{src:n.getImagenUrl(t.imagen),class:"q-mb-xs",style:{height:"120px"}},{default:i(()=>[o("div",Z,[o("div",A,c(r.$filters.textUpper(t.nombre)),1),o("div",H,[o("span",null,c(t.stock),1),o("span",J,c(t.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),256))])]),o("div",K,[o("div",W,[o("span",null,[s(p,{size:"xs",flat:"",round:"",dense:"",icon:"delete",color:"red",onClick:e[3]||(e[3]=t=>l.productosCompras=[]),class:"q-mb-sm"}),e[17]||(e[17]=o("span",{class:"text-subtitle2"},"Productos seleccionados",-1))]),o("span",null,[s(p,{size:"xs",dense:"",icon:"restore",color:"blue",class:"q-mb-sm",label:"Recuperar pedidos","no-caps":"",onClick:n.recuperarPedido},null,8,["onClick"])])]),s(k,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:i(()=>[e[19]||(e[19]=o("thead",null,[o("tr",null,[o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Producto"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Cantidad"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Precio unitario"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Total"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Factor"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Precio unitario 1.30"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Total"),o("th",{class:"pm-none",style:{"max-width":"60px","line-height":"0.9"}},"Precio venta"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Lote"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Fecha vencimiento"),o("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Dias vencimiento")])],-1)),o("tbody",null,[(h(!0),_(y,null,w(l.productosCompras,(t,u)=>(h(),_("tr",{key:u},[o("td",X,[s(C,{src:n.getImagenUrl(t.producto?.imagen),class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),o("div",Y,[s(I,{name:"delete",color:"red",class:"cursor-pointer",onClick:a=>l.productosCompras.splice(u,1)},null,8,["onClick"]),Q(" "+c(r.$filters.textUpper(t.producto?.nombre)),1)])]),o("td",$,[f(o("input",{"onUpdate:modelValue":a=>t.cantidad=a,type:"number",min:"0",style:{width:"60px"},onInput:a=>n.onCantidadChange(t)},null,40,ee),[[v,t.cantidad,void 0,{number:!0}]])]),o("td",oe,[f(o("input",{"onUpdate:modelValue":a=>t.precio=a,type:"number",min:"0",step:"0.001",style:{width:"70px"},onInput:a=>n.onPrecioChange(t)},null,40,te),[[v,t.precio,void 0,{number:!0}]])]),o("td",re,[f(o("input",{"onUpdate:modelValue":a=>t.total=a,type:"number",min:"0",step:"0.001",style:{width:"70px"},onInput:a=>n.onTotalChange(t)},null,40,se),[[v,t.total,void 0,{number:!0}]])]),o("td",le,[f(o("input",{"onUpdate:modelValue":a=>t.factor=a,type:"number",min:"0",step:"0.001",style:{width:"60px"},onInput:a=>n.onFactorChange(t)},null,40,ne),[[v,t.factor,void 0,{number:!0}]])]),o("td",ae,c(n.formatPrice(t.precio*t.factor))+" Bs ",1),o("td",ie,c(n.formatPrice(t.cantidad*t.precio*t.factor))+" Bs ",1),o("td",de,[f(o("input",{"onUpdate:modelValue":a=>t.precio_venta=a,type:"number",style:{width:"55px",color:"red","font-weight":"bold"},step:"0.1"},null,8,ce),[[v,t.precio_venta]])]),o("td",pe,[f(o("input",{"onUpdate:modelValue":a=>t.lote=a,type:"text",style:{width:"70px"}},null,8,me),[[v,t.lote]])]),o("td",ue,[f(o("input",{"onUpdate:modelValue":a=>t.fecha_vencimiento=a,type:"date",style:{width:"100px"}},null,8,he),[[v,t.fecha_vencimiento]])]),o("td",ge,[o("span",{class:E(`text-bold ${new Date(t.fecha_vencimiento)-new Date<0||Math.ceil((new Date(t.fecha_vencimiento)-new Date)/(1e3*60*60*24))<30?"text-red":Math.ceil((new Date(t.fecha_vencimiento)-new Date)/(1e3*60*60*24))<60?"text-orange":"text-green"}`)},c(n.tiempoRestante(t.fecha_vencimiento)),3)])]))),128))]),o("tfoot",null,[o("tr",null,[e[18]||(e[18]=o("td",{colspan:"3",class:"text-right"},"Total",-1)),o("td",fe,c(n.totalCompra)+" Bs",1)])])]),_:1}),s(p,{label:"Registrar compra",color:"primary",class:"full-width","no-caps":"",loading:l.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),s(D,{modelValue:l.compraDialog,"onUpdate:modelValue":e[9]||(e[9]=t=>l.compraDialog=t)},{default:i(()=>[s(b,{style:{width:"600px"}},{default:i(()=>[s(x,{class:"row items-center q-pb-none"},{default:i(()=>[e[20]||(e[20]=o("div",{class:"text-h6"},"Confirmar compra",-1)),s(P),s(p,{flat:"",round:"",dense:"",icon:"close",onClick:e[4]||(e[4]=t=>l.compraDialog=!1)})]),_:1}),s(x,null,{default:i(()=>[s(V,{onSubmit:n.submitCompra},{default:i(()=>[o("div",ve,[o("div",xe,[s(q,{modelValue:l.proveedor,"onUpdate:modelValue":[e[5]||(e[5]=t=>l.proveedor=t),e[6]||(e[6]=t=>{t?(this.compra.nombre=t.nombre||"",this.compra.ci=t.ci||""):(this.compra.nombre="",this.compra.ci="")})],options:l.proveedores,"option-label":"nombre","option-value":"id",label:"Proveedor",dense:"",outlined:"",rules:[t=>!!t||"Campo requerido"]},{append:i(()=>[s(p,{round:"",dense:"",flat:"",icon:"person_add",onClick:S(n.openProveedorDialog,["stop"]),title:"Nuevo proveedor"},null,8,["onClick"])]),_:1},8,["modelValue","options","rules"])]),o("div",_e,[s(q,{modelValue:l.compra.tipo_pago,"onUpdate:modelValue":e[7]||(e[7]=t=>l.compra.tipo_pago=t),options:["Efectivo","QR"],label:"Tipo de pago",dense:"",outlined:""},null,8,["modelValue"])]),o("div",be,[s(g,{modelValue:l.compra.nro_factura,"onUpdate:modelValue":e[8]||(e[8]=t=>l.compra.nro_factura=t),outlined:"",dense:"",label:"Nro. factura"},null,8,["modelValue"])]),o("div",ye,[s(k,{flat:"",dense:"","wrap-cells":"",bordered:""},{default:i(()=>[e[21]||(e[21]=o("thead",null,[o("tr",null,[o("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Producto"),o("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Cantidad"),o("th",{class:"pm-none",style:{"max-width":"60px","line-height":"0.9"}},"Precio venta"),o("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Lote"),o("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Fecha vencimiento")])],-1)),o("tbody",null,[(h(!0),_(y,null,w(l.productosCompras,(t,u)=>(h(),_("tr",{key:u},[o("td",we,[s(C,{src:n.getImagenUrl(t.producto?.imagen),class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),o("div",Ce,c(r.$filters.textUpper(t.producto?.nombre)),1)]),o("td",Ve,c(t.cantidad),1),o("td",Pe,c(n.formatPrice(t.precio_venta))+" Bs ",1),o("td",Ue,c(t.lote),1),o("td",De,c(t.fecha_vencimiento),1)]))),128))])]),_:1})])]),s(p,{label:"Guardar compra",color:"primary",class:"full-width q-mt-md",type:"submit","no-caps":"",icon:"save",loading:l.loading},null,8,["loading"])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(D,{modelValue:l.proveedorDialog,"onUpdate:modelValue":e[15]||(e[15]=t=>l.proveedorDialog=t),persistent:""},{default:i(()=>[s(b,{style:{width:"520px","max-width":"90vw"}},{default:i(()=>[s(x,{class:"row items-center q-pb-none"},{default:i(()=>[e[22]||(e[22]=o("div",{class:"text-h6"},"Nuevo proveedor",-1)),s(P),s(p,{flat:"",round:"",dense:"",icon:"close",onClick:n.closeProveedorDialog},null,8,["onClick"])]),_:1}),s(x,null,{default:i(()=>[s(V,{ref:"formProveedorRef",onSubmit:n.saveProveedor},{default:i(()=>[o("div",ke,[o("div",qe,[s(g,{modelValue:l.proveedorForm.nombre,"onUpdate:modelValue":e[10]||(e[10]=t=>l.proveedorForm.nombre=t),label:"Nombre *",dense:"",outlined:"",rules:[t=>!!t||"El nombre es obligatorio"]},null,8,["modelValue","rules"])]),o("div",Fe,[s(g,{modelValue:l.proveedorForm.ci,"onUpdate:modelValue":e[11]||(e[11]=t=>l.proveedorForm.ci=t),label:"CI",dense:"",outlined:""},null,8,["modelValue"])]),o("div",Ne,[s(g,{modelValue:l.proveedorForm.telefono,"onUpdate:modelValue":e[12]||(e[12]=t=>l.proveedorForm.telefono=t),label:"Teléfono",dense:"",outlined:""},null,8,["modelValue"])]),o("div",Qe,[s(g,{modelValue:l.proveedorForm.email,"onUpdate:modelValue":e[13]||(e[13]=t=>l.proveedorForm.email=t),label:"Email",type:"email",dense:"",outlined:""},null,8,["modelValue"])]),o("div",Ie,[s(g,{modelValue:l.proveedorForm.direccion,"onUpdate:modelValue":e[14]||(e[14]=t=>l.proveedorForm.direccion=t),label:"Dirección",type:"textarea",autogrow:"",dense:"",outlined:""},null,8,["modelValue"])])]),o("div",Ee,[s(P),s(p,{flat:"",label:"Cancelar",color:"grey-8",onClick:n.closeProveedorDialog},null,8,["onClick"]),s(p,{color:"primary",label:"Guardar",icon:"save",type:"submit",loading:l.loading},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e[23]||(e[23]=o("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}const Ke=F(G,[["render",Se]]);export{Ke as default};
